# 节点功能设计
- [节点管理服务](#节点管理服务)
    - [节点管理服务功能列表](#节点管理服务功能列表)
        - [与微服务通信](#与微服务通信)
        - [与节点通信](#与节点通信)
    - [指令流转通路](#指令流转通路)
    - [节点管理服务设计](#节点管理服务设计)
- [资源管理服务](#资源管理服务)
    - [资源管理服务功能列表](#资源管理服务功能列表)
        - [资源入网](#资源入网)
        - [资源查询](#资源查询)
    - [资源管理服务设计](#资源管理服务设计)
- [功能列表](#功能列表)

# 节点管理服务
节点管理服务端作为一个微服务的节点，能分别与微服务集群以及`ipfs`root节点集群通信，起到一个承上启下的作用。能更高效地管理`ipfs`节点。

![整体结构](./src/节点管理服务/整体结构.svg)

## 节点管理服务功能列表
### 与微服务通信
- 接收控制指令
    接收管理页面，资源管理服务的请求，对指定的节点做相关的操作。
- 查询节点信息
    通过整理指令完成情况，查询节点信息。
- 与存储服务通信
    将指令完成情况落库。

### 与节点通信
- 发送指令
    将接收到的指令，通过私有协议，中转给节点。
- 接收指令完成情况
    接收指令完成状况，完成信息存储。

## 指令流转通路
![指令流转通路](./src/节点管理服务/指令流转通路.svg)

## 节点管理服务设计
设计的主要特点是将`节点管理服务`的对外部分彻底分离，将业务抽象成`message`，在各个队列中流动。
将对同一个`io`的处理串行化，避免逻辑中大量的互斥锁操作。

### 一个业务的生命周期
- 从入口(`go-server-sdk`或者`ipfs protocal`)进入相应的入队列
- 触发`chan`的可读，相应的协程被唤醒
- 出队列，在新开协程(或者线程池中取出)中运行
- 处理完毕，进入相应的出队列
- 发送响应完毕

![设计流程](./src/节点管理服务/设计流程.svg)

# 资源管理服务
`资源管理服务`作为`ipfs`网络的统一入口，所有资源都通过该服务进入`ipfs`网络。
并为`播放端`提供查询服务，查询资源对应的`hash`以及哪些节点存储了该资源。

![大体功能](./src/资源管理服务/总体结构.svg)

## 资源管理服务功能列表
### 资源入网
资源入网必须指定`播放url`，根据业务方的情况，选择`回源url`或者`直接上传`。
|名词|含义|
|:---:|:---:|
|播放url|播放器播放的url，即资源的外部标识|
|回源url|业务方存储该资源的路径，通过该url可以访问到源资源|
|直接上传|业务方未存储该资源，直接存储在ipfs网络中|

#### 回源url
![回源url](./src/资源管理服务/回源url.svg)

#### 直接上传
![直接上传](./src/资源管理服务/直接上传.svg)

### 资源查询
根据传入的`播放url`，查询该资源对应的`hash`，以及存储了该资源的`节点`。
![资源查询](./src/资源管理服务/资源查询.svg)

## 资源管理服务设计
由于结构与`节点管理服务`非常相似，可以复用`节点管理服务`内部设计，整体业务流转逻辑完全一致。
将公用部分抽象独立，配置不同微服务配置，实例化不同的`message`和`messageHandler`。

![设计流程](./src/节点管理服务/设计流程.svg)

# 功能列表
## 节点管理服务
1. 指定节点删除文件
2. 指定节点添加文件
3. 修改指定节点启动节点地址
4. 修改指定节点仓库容量
5. 获取指定节点链接情况
6. 查询hash存储状况
7. 查询hash文件状况
8. 存储资源详情

## 资源管理服务
1. 接收上传请求
2. 上传请求重定向
3. 上传url发送给指定root节点
4. 接收url查询请求
5. 扩散hash

## 节点管理root节点
1. 重定向连上的节点
2. 查找指定节点
3. 中转`节点管理服务`的指令
4. 心跳链接情况
5. 中转上报信息

##  资源管理root节点
1. 拉取url并add进本地仓库，返回hash
2. 接收文件上传并add进本地仓库，返回hash
3. 接收并执行`资源管理服务`指令
4. 超时删除文件