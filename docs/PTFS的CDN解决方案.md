## PTFS的CDN解决方案

### CDN的内容注入规则
应用程序使用PTFS的应用层工具，使用专门的上传的接口来实现资源的导入。
资源首先导入到超级存储节点，超级存储节点再将资源push到每个分区的矿机节点。

#### 矿机节点的分区和分组规则
##### 分区
以矿机节点链接上的引导节点（超级管理节点）为单位，对矿机节点实现分区。矿机节点增加一个成员变量：区号（area id），区号为链接上的引导节点的id。
##### 分组
当矿机节点确认链接上超级管理节点后，超级管理节点会对矿机节点进行分组，并分配给矿机节点一个组号（group id）

`这里涉及到怎么分组的问题`引入参数N，假设N=20，每20个矿机为一组

#### 资源注入的流程
资源首先通过应用层上传工具导入到超级存储节点。

超级存储节点将资源push到每个矿机分区中一个合适的节点（这里应考虑矿机存储的负载均衡），作为存储备份。

当该节点拥有该资源的备份后，会复制该资源的拷贝并注入到该区域的分组矿机的热数据缓存中。

```
graph LR
资源注入-->矿机1组
资源注入-->矿机2组
资源注入-->矿机3组
资源注入-->矿机4组
```
假设一个矿机的热数据缓存空间是1T，如果我们将矿机分成了4组，那么整个系统的热数据缓存空间将变为1x4=4T。分组的目的正是为了扩充整个系统的热数据的缓存空间。


### 矿机的缓存框架
如果矿机的硬盘空间是2T，我们将矿机1T的空间用作数据存储，另外1T的空间用作CDN加速的缓存空间。

每个矿机上维护一个资源缓存列表。列表中罗列出该矿机上所有的热门缓存数据，并按照热度大小顺序排列。

如下图所示：

id | 热度
---|---
Qm001 | 200
Qm002 | 100
Qm003 | 50

当缓存空间达到临界值时，删除掉列表最底部较为冷门的数据，为压入新的热门数据腾出空间。

具体措施如下：

当缓存空间使用达到80%时，清理掉底部冷门数据，使得缓存空间恢复到50%

**所有资源的热度值暂时设置为0（热度公式需要根据不同的应用资源进行推演和模拟）**

**当一个资源产生有效下载时（过滤掉同一个资源在短时间内被同一个应用层节点下载的情况），将该资源提到列表顶部**

**当有一个新资源的缓存压入列表时候，也将该资源提到列表顶部**


### 遗留的问题

1. 矿机节点的分组策略问题
2. 资源的热度公式问题

参考的热度公式如下：

H ：热度

N ：有效下载次数（过滤掉同一个资源在短时间内被同一个应用层节点下载的情况）

T ： 该资源的发布时长（天）

P ：发布时长的参数

e ：发布时长的指数参数


热度公式如下：
```math
H = N/[(T + 1)*p]^e
```


3. 计算资源的热度主要是为了解决两个问题
    - 如果某个资源的热度非常高，高于某个数值。那么极有可能该矿工小组的节点（假如该小组有20个节点）无法负载。这时就需要更多的节点来缓存该资源。
    - 如果某节点的底部资源热度过高，高于某个数值。说明该节点的CDN缓存区都是热门资源。那么就需要引入更多的节点分组来负载新的资源。

4. 如果一个hash资源，因为过冷，从所有的缓存队列中被移除了。某一天，它突然又火起来了，那么它要通过一种什么样的方式，重新加入缓存队列中呢？
    - 解决方案思考：每个资源就算是备份的存储资源也会在本地维护一个热度值。如果热度值高于某个值之后，就申请一组节点来将该资源重新添加到缓存队列


### 指标参考

1. 命中率

有多少次资源的下载链接，是通过缓存空间下载的，在总下载链接次数中的占比
2. 吞吐量

矿机节点的CDN功能在单位时间内成功传输的数据大小（和矿机的CPU，内存，磁盘类型，磁盘大小，磁盘缓存，网卡类型，网卡速度，总线速度，硬盘I/O；还有操作系统，网络带宽等）
3. 并发值

整个节点系统能支持多少个应用层节点的并发链接，和超级管理节点，矿机节点是怎样的对应关系
4. 响应时间

应用层节点发出下载资源的请求，到收到第一个数据块的间隔时间
5. 应用层节点的下载速度

如果应用层节点的下载速度能达到3MB/S，考虑限速的问题




